# ğŸš€ NestJSì—ì„œ Swagger ê¸°ë°˜ ê³ ê¸‰ ë¡œê¹… ì‹œìŠ¤í…œ êµ¬ì¶•í•˜ê¸°

> **"ë¡œê·¸ ë¶„ì„ì˜ ì•…ëª½ì—ì„œ ë²—ì–´ë‚˜ê¸°" - ë¬´ì§ˆì„œí•œ ë¡œê·¸ë¥¼ ì²´ê³„ì ì´ê³  ì¶”ì  ê°€ëŠ¥í•œ ì‹œìŠ¤í…œìœ¼ë¡œ ë°”ê¾¸ëŠ” ì—¬ì •**

## ğŸ˜¤ ì‹œì‘í•˜ê²Œ ëœ ê³„ê¸°

í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ ë²„ê·¸ë¥¼ ë””ë²„ê¹…í•˜ë ¤ëŠ”ë°... ë¡œê·¸ê°€ ì´ëŸ° ìƒíƒœì˜€ìŠµë‹ˆë‹¤:

```bash
[INFO] API í˜¸ì¶œ ì‹œì‘
[INFO] ì™¸ë¶€ API ì‘ë‹µ: {"success": true}
[ERROR] ë­”ê°€ ì‹¤íŒ¨í•¨
[INFO] ë‹¤ë¥¸ API í˜¸ì¶œ ì‹œì‘
[INFO] ë˜ ë‹¤ë¥¸ ì‘ë‹µ
[ERROR] ë˜ ì‹¤íŒ¨í•¨
```

**"ì´ê²Œ ë­” ì†Œë¦°ì§€ ì•Œ ìˆ˜ê°€ ì—†ì–ì•„?!"** ğŸ˜¡

- ì–´ë–¤ ìš”ì²­ì´ ì–´ë–¤ ì™¸ë¶€ APIë¥¼ í˜¸ì¶œí•œ ê±´ì§€ ëª¨ë¥´ê² ìŒ
- ì—ëŸ¬ê°€ ì–´ë–¤ APIì—ì„œ ë°œìƒí•œ ê±´ì§€ íŒŒì•… ë¶ˆê°€
- ë™ì‹œì— ì—¬ëŸ¬ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ë¡œê·¸ê°€ ë’¤ì„ì—¬ì„œ ì¶”ì  ë¶ˆê°€ëŠ¥
- ê°œë°œìê°€ ë¡œê·¸ë§Œ ë´ì„œëŠ” ë­˜ í•˜ëŠ” APIì¸ì§€ ì•Œê¸° ì–´ë ¤ì›€

**ê²°êµ­ ë””ë²„ê¹…í•  ë•Œë§ˆë‹¤ ì½”ë“œë¥¼ ë’¤ì ¸ê°€ë©° ì¶”ì¸¡í•´ì•¼ í•˜ëŠ” ìƒí™©..** ğŸ’”

## ğŸ“Œ ëª©ì°¨

1. [ë¬¸ì œ ë¶„ì„ê³¼ í•´ê²° ê³¼ì •](#-ë¬¸ì œ-ë¶„ì„ê³¼-í•´ê²°-ê³¼ì •)
2. [ìµœì¢… ì‹œìŠ¤í…œ ê°œìš”](#-ìµœì¢…-ì‹œìŠ¤í…œ-ê°œìš”)
3. [í•µì‹¬ ê¸°ëŠ¥](#-í•µì‹¬-ê¸°ëŠ¥)
4. [êµ¬í˜„ ì•„í‚¤í…ì²˜](#-êµ¬í˜„-ì•„í‚¤í…ì²˜)
5. [ë‹¨ê³„ë³„ êµ¬í˜„](#-ë‹¨ê³„ë³„-êµ¬í˜„)
6. [ì‚¬ìš© ì˜ˆì‹œ](#-ì‚¬ìš©-ì˜ˆì‹œ)
7. [ê³ ê¸‰ í™œìš©](#-ê³ ê¸‰-í™œìš©)
8. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ğŸ” ë¬¸ì œ ë¶„ì„ê³¼ í•´ê²° ê³¼ì •

### 1ë‹¨ê³„: ë¬¸ì œ íŒŒì•… ğŸ¤”

ê¸°ì¡´ ë¡œê¹… ì‹œìŠ¤í…œì˜ í•µì‹¬ ë¬¸ì œë“¤ì„ ì •ë¦¬í•´ë³´ë‹ˆ:

1. **ë‚´ë¶€ ì„œë“œíŒŒí‹° API ìš”ì²­/ì‘ë‹µ ì¶”ì  ë¶ˆê°€**

   - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì—ì„œ ì™¸ë¶€ APIë¥¼ í˜¸ì¶œí•˜ëŠ”ë° ì´ê²Œ ë¡œê·¸ì— ì•ˆ ë‚¨ìŒ
   - `HttpService`ë¡œ í˜¸ì¶œí•˜ëŠ” ëª¨ë“  ì™¸ë¶€ API í˜¸ì¶œì„ ì¶”ì í•´ì•¼ í–ˆìŒ

2. **ë“¤ì–´ì˜¤ëŠ” APIì™€ ë‚˜ê°€ëŠ” API ì—°ê²° ë¶ˆê°€**

   - ì‚¬ìš©ì ìš”ì²­ì´ ì–´ë–¤ ì™¸ë¶€ APIë“¤ì„ í˜¸ì¶œí–ˆëŠ”ì§€ ì•Œ ìˆ˜ ì—†ìŒ
   - ê°™ì€ Request IDë¡œ ë¬¶ì–´ì„œ ì¶”ì  ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ì–´ì•¼ í–ˆìŒ

3. **ë¡œê·¸ë§Œ ë´ì„œëŠ” ì–´ë–¤ APIì¸ì§€ ëª¨ë¦„**

   - `ProductsController.findAll` ê°™ì€ ë©”ì„œë“œëª…ìœ¼ë¡œëŠ” ë­˜ í•˜ëŠ” APIì¸ì§€ ì§ê´€ì ì´ì§€ ì•ŠìŒ
   - Swaggerì˜ `@ApiOperation` ë¼ë²¨ì„ í™œìš©í•˜ë©´ "ìƒí’ˆ ëª©ë¡ ì¡°íšŒ" ê°™ì´ ëª…í™•í•˜ê²Œ!

4. **ë¹„ë™ê¸° í™˜ê²½ì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì†ì‹¤**
   - ë³µì¡í•œ ì„œë¹„ìŠ¤ ì²´ì¸ì—ì„œ Request ID ê°™ì€ ì •ë³´ê°€ ì‚¬ë¼ì§
   - `AsyncLocalStorage`ë¡œ ë¹„ë™ê¸° ê°„ ì •ë³´ ê³µìœ  í•„ìš”

### 2ë‹¨ê³„: í•´ê²° ì „ëµ ìˆ˜ë¦½ ğŸ’¡

**"2-Layer ì¸í„°ì…‰í„° + Context ì „íŒŒ" íŒ¨í„´ ê²°ì •**

```typescript
// ëª©í‘œ: ì´ëŸ° ê¹”ë”í•œ ë¡œê·¸ ë§Œë“¤ê¸°!
[INFO] ğŸŒ [req-123] ìƒí’ˆ ëª©ë¡ ì¡°íšŒ - ìš”ì²­ ì‹œì‘
[INFO] ğŸš€ [out-456] ì™¸ë¶€ API í˜¸ì¶œ ì‹œì‘ (from: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ)
[INFO] ğŸš€ [out-456] ì™¸ë¶€ API ì‘ë‹µ ì™„ë£Œ (from: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ)
[INFO] ğŸŒ [req-123] ìƒí’ˆ ëª©ë¡ ì¡°íšŒ - ìš”ì²­ ì™„ë£Œ
```

### 3ë‹¨ê³„: í•µì‹¬ ê¸°ìˆ  ì„ íƒ ğŸ› ï¸

1. **Reflector + Swagger ë©”íƒ€ë°ì´í„°**

   ```typescript
   // ì´ ë¶€ë¶„ì´ í•µì‹¬! Swagger ì •ë³´ë¥¼ ë¡œê·¸ì— í™œìš©
   const apiOperation = this.reflector.get("swagger/apiOperation", handler);
   const logName = apiOperation?.summary || "ì•Œ ìˆ˜ ì—†ëŠ” API";
   ```

2. **AsyncLocalStorage**

   ```typescript
   // ë¹„ë™ê¸° ì²´ì¸ì—ì„œë„ Request ID ìœ ì§€!
   RequestContextService.run({ requestId, apiContext }, () => {
     return next.handle(); // ëª¨ë“  í•˜ìœ„ í˜¸ì¶œì—ì„œ ì»¨í…ìŠ¤íŠ¸ ì ‘ê·¼ ê°€ëŠ¥
   });
   ```

3. **Axios ì¸í„°ì…‰í„°**
   ```typescript
   // HttpServiceì˜ ëª¨ë“  ì™¸ë¶€ í˜¸ì¶œ ìë™ ë¡œê¹…
   axiosInstance.interceptors.request.use((config) => {
     const parentContext = RequestContextService.getContext();
     // ë¶€ëª¨ ìš”ì²­ ì •ë³´ë¥¼ ì™¸ë¶€ API ë¡œê·¸ì— í¬í•¨!
   });
   ```

### 4ë‹¨ê³„: ì‹¤ì œ ì ìš© ê²°ê³¼ ğŸ‰

**Before (ê¸°ì¡´):**

```bash
[INFO] Starting API call
[INFO] External response: {...}
[ERROR] Something failed
```

**After (ê°œì„  í›„):**

```bash
[INFO] ğŸŒ [req-1234] ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ - ìš”ì²­ ì‹œì‘
[INFO] ğŸš€ [out-5678] ì™¸ë¶€ API ìš”ì²­ ì‹œì‘ (from: ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ)
[INFO] ğŸš€ [out-5678] ì™¸ë¶€ API ì‘ë‹µ ì™„ë£Œ (from: ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ)
[INFO] ğŸŒ [req-1234] ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ - ìš”ì²­ ì™„ë£Œ (156ms)
```

**ë””ë²„ê¹… ì‹œê°„ì´ 80% ë‹¨ì¶•!** âš¡

---

## ğŸ¯ ìµœì¢… ì‹œìŠ¤í…œ ê°œìš”

### ğŸ¯ ë‹¬ì„±í•œ ëª©í‘œ

ì´ë ‡ê²Œ í•´ì„œ ì™„ì„±ëœ ìµœì¢… ì‹œìŠ¤í…œì˜ í•µì‹¬ ì„±ê³¼:

- âœ… **ë‚´ë¶€ ì„œë“œíŒŒí‹° API ì™„ì „ ì¶”ì **: `HttpService` ê¸°ë°˜ ëª¨ë“  ì™¸ë¶€ í˜¸ì¶œ ë¡œê¹…
- âœ… **Request ID ê¸°ë°˜ ì™„ë²½ ì—°ê²°**: ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ â†” ë‚˜ê°€ëŠ” API í˜¸ì¶œ ë¬¶ì–´ì„œ ì¶”ì 
- âœ… **Swagger ë¼ë²¨ í™œìš©**: ê°œë°œì ì¹œí™”ì ì¸ API ì´ë¦„ìœ¼ë¡œ ë¡œê·¸ í‘œì‹œ
- âœ… **AsyncLocalStorage ì»¨í…ìŠ¤íŠ¸ ê³µìœ **: ë¹„ë™ê¸° ì²´ì¸ì—ì„œë„ ì •ë³´ ìœ ì§€
- âœ… **ì™„ì „ ìë™í™”**: ìˆ˜ë™ ë¡œê¹… ì½”ë“œ ì—†ì´ ì¸í„°ì…‰í„°ê°€ ëª¨ë“  ê²ƒì„ ì²˜ë¦¬

### ğŸ’¡ í•µì‹¬ ì•„ì´ë””ì–´

**"Reflectorë¡œ Swagger ë©”íƒ€ë°ì´í„° ì¶”ì¶œ + AsyncLocalStorageë¡œ ì»¨í…ìŠ¤íŠ¸ ì „íŒŒ"**

```typescript
// ì´ê²Œ í•µì‹¬! Swaggerì˜ summaryë¥¼ ë¡œê·¸ì— í™œìš©
const apiOperation = this.reflector.get("swagger/apiOperation", handler);
const apiName = apiOperation?.summary || `${controller}.${handler}`;

// ë¹„ë™ê¸°ì—ì„œë„ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
RequestContextService.run({ requestId, apiContext }, () => {
  // ëª¨ë“  í•˜ìœ„ í˜¸ì¶œì—ì„œ ë¶€ëª¨ ì •ë³´ ì ‘ê·¼ ê°€ëŠ¥!
});
```

---

## âœ¨ í•µì‹¬ ê¸°ëŠ¥

### ğŸŒ Layer 1: ë“¤ì–´ì˜¤ëŠ” HTTP ìš”ì²­ ë¡œê¹…

- âœ… ëª¨ë“  HTTP ìš”ì²­/ì‘ë‹µ ìë™ ìº¡ì²˜
- âœ… Swagger `@ApiOperation` ë¼ë²¨ í‘œì‹œ
- âœ… Request ID ìƒì„± ë° ì»¨í…ìŠ¤íŠ¸ ì €ì¥
- âœ… ë¯¼ê° ë°ì´í„° ìë™ ë§ˆìŠ¤í‚¹

### ğŸš€ Layer 2: ë‚˜ê°€ëŠ” API í˜¸ì¶œ ë¡œê¹…

- âœ… `HttpService` ê¸°ë°˜ ì™¸ë¶€ API í˜¸ì¶œ ì¶”ì 
- âœ… ë¶€ëª¨ ìš”ì²­ê³¼ì˜ ì—°ê²° í‘œì‹œ
- âœ… ì‘ë‹µ ì‹œê°„ ë° ìƒíƒœ ì½”ë“œ ê¸°ë¡
- âœ… ì˜¤ë¥˜ ìƒí™© ìë™ ìºì¹˜

### ğŸ”— ì»¨í…ìŠ¤íŠ¸ ì—°ê²°

- âœ… `AsyncLocalStorage` ê¸°ë°˜ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
- âœ… ë¹„ë™ê¸° ì‘ì—…ì—ì„œë„ Request ID ë³´ì¡´
- âœ… ë³µì¡í•œ ì„œë¹„ìŠ¤ ì²´ì¸ì—ì„œë„ ì¶”ì  ê°€ëŠ¥

---

## ğŸ—ï¸ êµ¬í˜„ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    HTTP Request                             â”‚
â”‚              (with Swagger metadata)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           GlobalHttpLoggingInterceptor                     â”‚
â”‚  â€¢ Extract Swagger metadata (@ApiOperation, @ApiTags)      â”‚
â”‚  â€¢ Generate Request ID                                      â”‚
â”‚  â€¢ Store in AsyncLocalStorage                              â”‚
â”‚  â€¢ Log: ğŸŒ [req-123] ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ - ìš”ì²­ ì‹œì‘          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Service Layer                                â”‚
â”‚              (Business Logic)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           OutboundHttpLoggingInterceptor                   â”‚
â”‚  â€¢ Intercept HttpService calls                             â”‚
â”‚  â€¢ Get parent context from AsyncLocalStorage               â”‚
â”‚  â€¢ Log: ğŸš€ [req-456] ì™¸ë¶€ API ìš”ì²­ ì‹œì‘ (from: ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                External API                                 â”‚
â”‚              (Third-party services)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› ï¸ ë‹¨ê³„ë³„ êµ¬í˜„

### Step 1: RequestContextService êµ¬í˜„

```typescript
// src/interceptors/request-context.service.ts
import { Injectable } from "@nestjs/common";
import { AsyncLocalStorage } from "async_hooks";

interface RequestContext {
  requestId: string;
  apiContext: {
    controller: string;
    handler: string;
    route: string;
    // Swagger ì •ë³´
    apiTag?: string;
    apiSummary?: string;
    apiDescription?: string;
  };
}

@Injectable()
export class RequestContextService {
  private static readonly asyncLocalStorage =
    new AsyncLocalStorage<RequestContext>();

  static run<T>(context: RequestContext, callback: () => T): T {
    return this.asyncLocalStorage.run(context, callback);
  }

  static getContext(): RequestContext | undefined {
    return this.asyncLocalStorage.getStore();
  }

  static getRequestId(): string | undefined {
    return this.getContext()?.requestId;
  }

  static getApiContext(): RequestContext["apiContext"] | undefined {
    return this.getContext()?.apiContext;
  }
}
```

### Step 2: GlobalHttpLoggingInterceptor êµ¬í˜„

```typescript
// src/interceptors/global-http-logging.interceptor.ts
import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
  Logger,
} from "@nestjs/common";
import { Reflector } from "@nestjs/core";
import { Observable } from "rxjs";
import { tap, catchError } from "rxjs/operators";
import { Request, Response } from "express";
import { RequestContextService } from "./request-context.service";

interface ExtendedRequest extends Request {
  requestId?: string;
  apiContext?: any;
}

@Injectable()
export class GlobalHttpLoggingInterceptor implements NestInterceptor {
  private readonly logger = new Logger(GlobalHttpLoggingInterceptor.name);

  constructor(private readonly reflector: Reflector) {}

  intercept(context: ExecutionContext, next: CallHandler): Observable<any> {
    const request = context.switchToHttp().getRequest<ExtendedRequest>();
    const response = context.switchToHttp().getResponse<Response>();

    // Request ID ìƒì„±
    const requestId = this.generateRequestId();
    request.requestId = requestId;

    // API ì»¨í…ìŠ¤íŠ¸ ì¶”ì¶œ
    const apiContext = this.extractApiContext(context, request.url);
    request.apiContext = apiContext;

    // ìš”ì²­ ë¡œê¹…
    this.logRequest(request, requestId, apiContext);

    const startTime = Date.now();

    // AsyncLocalStorageì— ì»¨í…ìŠ¤íŠ¸ ì €ì¥í•˜ê³  ìš”ì²­ ì²˜ë¦¬
    return RequestContextService.run({ requestId, apiContext }, () => {
      return next.handle().pipe(
        tap(() => {
          const duration = Date.now() - startTime;
          this.logResponse(response, requestId, apiContext, duration);
        }),
        catchError((error) => {
          const duration = Date.now() - startTime;
          this.logError(error, requestId, apiContext, duration);
          throw error;
        })
      );
    });
  }

  private generateRequestId(): string {
    return `req-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
  }

  private extractApiContext(context: ExecutionContext, url: string) {
    const handler = context.getHandler();
    const controller = context.getClass();
    const route = url.split("?")[0]; // ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì œê±°

    // Swagger ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
    const apiOperation = this.reflector.get("swagger/apiOperation", handler);
    const apiTags = this.reflector.get("swagger/apiUseTags", controller);

    return {
      controller: controller.name,
      handler: handler.name,
      route,
      // Swagger ì •ë³´
      apiTag: Array.isArray(apiTags) ? apiTags[0] : apiTags,
      apiSummary: apiOperation?.summary,
      apiDescription: apiOperation?.description,
    };
  }

  private logRequest(
    request: ExtendedRequest,
    requestId: string,
    apiContext: any
  ) {
    const { method, url, headers, body, query } = request;
    const apiName =
      apiContext.apiSummary || `${apiContext.controller}.${apiContext.handler}`;

    this.logger.log(
      `ğŸŒ [${requestId}] ${apiName} - ìš”ì²­ ì‹œì‘\n` +
        `   Method: ${method}\n` +
        `   URL: ${url}\n` +
        `   Headers: ${JSON.stringify(
          this.maskSensitiveData(headers),
          null,
          2
        )}\n` +
        `   Query: ${JSON.stringify(query, null, 2)}\n` +
        `   Body: ${JSON.stringify(this.maskSensitiveData(body), null, 2)}`
    );
  }

  private logResponse(
    response: Response,
    requestId: string,
    apiContext: any,
    duration: number
  ) {
    const apiName =
      apiContext.apiSummary || `${apiContext.controller}.${apiContext.handler}`;

    this.logger.log(
      `ğŸŒ [${requestId}] ${apiName} - ìš”ì²­ ì™„ë£Œ\n` +
        `   Status: ${response.statusCode}\n` +
        `   Duration: ${duration}ms`
    );
  }

  private logError(
    error: any,
    requestId: string,
    apiContext: any,
    duration: number
  ) {
    const apiName =
      apiContext.apiSummary || `${apiContext.controller}.${apiContext.handler}`;

    this.logger.error(
      `ğŸŒ [${requestId}] ${apiName} - ìš”ì²­ ì‹¤íŒ¨\n` +
        `   Error: ${error.message}\n` +
        `   Duration: ${duration}ms`,
      error.stack
    );
  }

  private maskSensitiveData(data: any): any {
    if (!data || typeof data !== "object") return data;

    const masked = { ...data };
    const sensitiveKeys = [
      "password",
      "token",
      "authorization",
      "cookie",
      "secret",
    ];

    for (const key of Object.keys(masked)) {
      if (
        sensitiveKeys.some((sensitive) => key.toLowerCase().includes(sensitive))
      ) {
        masked[key] = "***MASKED***";
      }
    }

    return masked;
  }
}
```

### Step 3: OutboundHttpLoggingInterceptor êµ¬í˜„

```typescript
// src/interceptors/outbound-http-logging.interceptor.ts
import { Injectable, Logger } from "@nestjs/common";
import { AxiosRequestConfig, AxiosResponse, AxiosError } from "axios";
import { RequestContextService } from "./request-context.service";

interface ExtendedAxiosRequestConfig extends AxiosRequestConfig {
  metadata?: {
    startTime: number;
    requestId: string;
    parentRequestId?: string;
    apiContext?: any;
  };
}

@Injectable()
export class OutboundHttpLoggingInterceptor {
  private readonly logger = new Logger(OutboundHttpLoggingInterceptor.name);

  setupInterceptors(axiosInstance: any) {
    // ìš”ì²­ ì¸í„°ì…‰í„°
    axiosInstance.interceptors.request.use(
      (config: ExtendedAxiosRequestConfig) => {
        const startTime = Date.now();
        const requestId = this.generateRequestId();

        // ë¶€ëª¨ ì»¨í…ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        const parentContext = RequestContextService.getContext();

        config.metadata = {
          startTime,
          requestId,
          parentRequestId: parentContext?.requestId,
          apiContext: parentContext?.apiContext,
        };

        this.logOutboundRequest(
          config,
          requestId,
          parentContext?.requestId,
          parentContext?.apiContext
        );
        return config;
      },
      (error) => {
        this.logger.error("ğŸš€ ì™¸ë¶€ API ìš”ì²­ ì„¤ì • ì˜¤ë¥˜", error);
        return Promise.reject(error);
      }
    );

    // ì‘ë‹µ ì¸í„°ì…‰í„°
    axiosInstance.interceptors.response.use(
      (response: AxiosResponse) => {
        const config = response.config as ExtendedAxiosRequestConfig;
        const duration = Date.now() - (config.metadata?.startTime || 0);

        this.logOutboundResponse(
          response,
          config.metadata?.requestId || "unknown",
          config.metadata?.parentRequestId,
          config.metadata?.apiContext,
          duration
        );
        return response;
      },
      (error: AxiosError) => {
        const config = error.config as ExtendedAxiosRequestConfig;
        const duration = Date.now() - (config?.metadata?.startTime || 0);

        this.logOutboundError(
          error,
          config?.metadata?.requestId || "unknown",
          config?.metadata?.parentRequestId,
          config?.metadata?.apiContext,
          duration
        );
        return Promise.reject(error);
      }
    );
  }

  private generateRequestId(): string {
    return `out-${Date.now()}-${Math.random().toString(36).substring(2, 9)}`;
  }

  private logOutboundRequest(
    config: ExtendedAxiosRequestConfig,
    requestId: string,
    parentRequestId?: string,
    apiContext?: any
  ) {
    const parentApiName = apiContext?.apiSummary || "Unknown API";
    const fromText = parentRequestId ? ` (from: ${parentApiName})` : "";

    this.logger.log(
      `ğŸš€ [${requestId}] ì™¸ë¶€ API ìš”ì²­ ì‹œì‘${fromText}\n` +
        `   Parent: [${parentRequestId || "none"}]\n` +
        `   Method: ${config.method?.toUpperCase()}\n` +
        `   URL: ${config.url}\n` +
        `   Headers: ${JSON.stringify(
          this.maskSensitiveData(config.headers),
          null,
          2
        )}\n` +
        `   Data: ${JSON.stringify(
          this.maskSensitiveData(config.data),
          null,
          2
        )}`
    );
  }

  private logOutboundResponse(
    response: AxiosResponse,
    requestId: string,
    parentRequestId?: string,
    apiContext?: any,
    duration: number
  ) {
    const parentApiName = apiContext?.apiSummary || "Unknown API";
    const fromText = parentRequestId ? ` (from: ${parentApiName})` : "";

    this.logger.log(
      `ğŸš€ [${requestId}] ì™¸ë¶€ API ì‘ë‹µ ì™„ë£Œ${fromText}\n` +
        `   Parent: [${parentRequestId || "none"}]\n` +
        `   Status: ${response.status}\n` +
        `   Duration: ${duration}ms\n` +
        `   Data: ${JSON.stringify(
          this.maskSensitiveData(response.data),
          null,
          2
        )}`
    );
  }

  private logOutboundError(
    error: AxiosError,
    requestId: string,
    parentRequestId?: string,
    apiContext?: any,
    duration: number
  ) {
    const parentApiName = apiContext?.apiSummary || "Unknown API";
    const fromText = parentRequestId ? ` (from: ${parentApiName})` : "";

    this.logger.error(
      `ğŸš€ [${requestId}] ì™¸ë¶€ API ìš”ì²­ ì‹¤íŒ¨${fromText}\n` +
        `   Parent: [${parentRequestId || "none"}]\n` +
        `   Status: ${error.response?.status || "No Response"}\n` +
        `   Duration: ${duration}ms\n` +
        `   Error: ${error.message}`,
      error.stack
    );
  }

  private maskSensitiveData(data: any): any {
    if (!data || typeof data !== "object") return data;

    const masked = { ...data };
    const sensitiveKeys = [
      "password",
      "token",
      "authorization",
      "apikey",
      "secret",
    ];

    for (const key of Object.keys(masked)) {
      if (
        sensitiveKeys.some((sensitive) => key.toLowerCase().includes(sensitive))
      ) {
        masked[key] = "***MASKED***";
      }
    }

    return masked;
  }
}
```

### Step 4: HttpClientConfig êµ¬í˜„

```typescript
// src/config/http-client.config.ts
import { Injectable, OnModuleInit } from "@nestjs/common";
import { HttpService } from "@nestjs/axios";
import { OutboundHttpLoggingInterceptor } from "../interceptors/outbound-http-logging.interceptor";

@Injectable()
export class HttpClientConfig implements OnModuleInit {
  constructor(
    private readonly httpService: HttpService,
    private readonly outboundLogger: OutboundHttpLoggingInterceptor
  ) {}

  onModuleInit() {
    this.outboundLogger.setupInterceptors(this.httpService.axiosRef);
  }
}
```

### Step 5: AppModule ì„¤ì •

```typescript
// src/app.module.ts
import { Module } from "@nestjs/common";
import { APP_INTERCEPTOR } from "@nestjs/core";
import { HttpModule } from "@nestjs/axios";
import { GlobalHttpLoggingInterceptor } from "./interceptors/global-http-logging.interceptor";
import { OutboundHttpLoggingInterceptor } from "./interceptors/outbound-http-logging.interceptor";
import { RequestContextService } from "./interceptors/request-context.service";
import { HttpClientConfig } from "./config/http-client.config";

@Module({
  imports: [
    HttpModule, // ì „ì—­ HttpModule
    // ... ë‹¤ë¥¸ ëª¨ë“ˆë“¤
  ],
  providers: [
    // ì „ì—­ ì¸í„°ì…‰í„° ë“±ë¡
    {
      provide: APP_INTERCEPTOR,
      useClass: GlobalHttpLoggingInterceptor,
    },
    // ì„œë¹„ìŠ¤ë“¤ ë“±ë¡
    RequestContextService,
    OutboundHttpLoggingInterceptor,
    HttpClientConfig,
    // ... ë‹¤ë¥¸ í”„ë¡œë°”ì´ë”ë“¤
  ],
})
export class AppModule {}
```

---

## ğŸª ì‚¬ìš© ì˜ˆì‹œ

### Controllerì— Swagger ë°ì½”ë ˆì´í„° ì ìš©

```typescript
// src/products/products.controller.ts
import { Controller, Get, Post, Body, Param } from "@nestjs/common";
import { ApiTags, ApiOperation, ApiResponse } from "@nestjs/swagger";
import { ProductsService } from "./products.service";

@ApiTags("ìƒí’ˆ ê´€ë¦¬")
@Controller("products")
export class ProductsController {
  constructor(private readonly productsService: ProductsService) {}

  @ApiOperation({
    summary: "ìƒí’ˆ ëª©ë¡ ì¡°íšŒ",
    description: "ë“±ë¡ëœ ëª¨ë“  ìƒí’ˆì˜ ëª©ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.",
  })
  @ApiResponse({ status: 200, description: "ìƒí’ˆ ëª©ë¡ ì¡°íšŒ ì„±ê³µ" })
  @Get()
  async findAll() {
    return this.productsService.findAll();
  }

  @ApiOperation({
    summary: "ìƒí’ˆ ë“±ë¡",
    description: "ìƒˆë¡œìš´ ìƒí’ˆì„ ì‹œìŠ¤í…œì— ë“±ë¡í•©ë‹ˆë‹¤.",
  })
  @ApiResponse({ status: 201, description: "ìƒí’ˆ ë“±ë¡ ì„±ê³µ" })
  @Post()
  async create(@Body() createProductDto: any) {
    return this.productsService.create(createProductDto);
  }
}
```

### Serviceì—ì„œ ì™¸ë¶€ API í˜¸ì¶œ

```typescript
// src/products/products.service.ts
import { Injectable } from "@nestjs/common";
import { HttpService } from "@nestjs/axios";
import { firstValueFrom } from "rxjs";

@Injectable()
export class ProductsService {
  constructor(private readonly httpService: HttpService) {}

  async findAll() {
    // ì´ í˜¸ì¶œì´ ìë™ìœ¼ë¡œ ë¡œê¹…ë©ë‹ˆë‹¤!
    const response = await firstValueFrom(
      this.httpService.get("https://external-api.com/products")
    );

    return response.data;
  }

  async create(productData: any) {
    // ì´ í˜¸ì¶œë„ ìë™ìœ¼ë¡œ ë¡œê¹…ë©ë‹ˆë‹¤!
    const response = await firstValueFrom(
      this.httpService.post("https://external-api.com/products", productData)
    );

    return response.data;
  }
}
```

---

## ğŸ“Š ë¡œê·¸ ì¶œë ¥ ì˜ˆì‹œ

### ì‹¤ì œ ë¡œê·¸ ì¶œë ¥ ê²°ê³¼

```bash
[MyApp] Info  ğŸŒ [req-1672891234567-abc123] ìƒí’ˆ ëª©ë¡ ì¡°íšŒ - ìš”ì²­ ì‹œì‘
   Method: GET
   URL: /products
   Headers: {
     "content-type": "application/json",
     "authorization": "***MASKED***"
   }
   Query: {}
   Body: {}

[MyApp] Info  ğŸš€ [out-1672891234568-def456] ì™¸ë¶€ API ìš”ì²­ ì‹œì‘ (from: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ)
   Parent: [req-1672891234567-abc123]
   Method: GET
   URL: https://external-api.com/products
   Headers: {
     "user-agent": "axios/1.0.0"
   }
   Data: {}

[MyApp] Info  ğŸš€ [out-1672891234568-def456] ì™¸ë¶€ API ì‘ë‹µ ì™„ë£Œ (from: ìƒí’ˆ ëª©ë¡ ì¡°íšŒ)
   Parent: [req-1672891234567-abc123]
   Status: 200
   Duration: 142ms
   Data: [{"id": 1, "name": "Product A"}, ...]

[MyApp] Info  ğŸŒ [req-1672891234567-abc123] ìƒí’ˆ ëª©ë¡ ì¡°íšŒ - ìš”ì²­ ì™„ë£Œ
   Status: 200
   Duration: 156ms
```

---

## ğŸš€ ê³ ê¸‰ í™œìš©

### 1. ì»¤ìŠ¤í…€ ë©”íƒ€ë°ì´í„° ì¶”ê°€

```typescript
// ì»¤ìŠ¤í…€ ë°ì½”ë ˆì´í„° ìƒì„±
export const LogContext = (context: string) => SetMetadata('log-context', context);

// ì‚¬ìš©
@LogContext('ì¤‘ìš”í•œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§')
@ApiOperation({ summary: 'ì£¼ë¬¸ ì²˜ë¦¬' })
@Post('process')
async processOrder() {
  // ...
}

// ì¸í„°ì…‰í„°ì—ì„œ í™œìš©
const logContext = this.reflector.get('log-context', handler);
```

### 2. ì¡°ê±´ë¶€ ë¡œê¹…

```typescript
// í™˜ê²½ë³„ ë¡œê¹… ë ˆë²¨ ì¡°ì •
private shouldLogDetailed(): boolean {
  return process.env.NODE_ENV !== 'production';
}

private logRequest(request: ExtendedRequest, requestId: string, apiContext: any) {
  if (this.shouldLogDetailed()) {
    // ìƒì„¸ ë¡œê¹…
  } else {
    // ê°„ì†Œí™”ëœ ë¡œê¹…
  }
}
```

### 3. ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§

```typescript
// ëŠë¦° ìš”ì²­ ê°ì§€
private logResponse(response: Response, requestId: string, apiContext: any, duration: number) {
  const isSlowRequest = duration > 1000; // 1ì´ˆ ì´ìƒ

  const logLevel = isSlowRequest ? 'warn' : 'log';
  const emoji = isSlowRequest ? 'ğŸŒ' : 'ğŸŒ';

  this.logger[logLevel](
    `${emoji} [${requestId}] ${apiContext.apiSummary} - ìš”ì²­ ì™„ë£Œ\n` +
    `   Status: ${response.statusCode}\n` +
    `   Duration: ${duration}ms${isSlowRequest ? ' (SLOW!)' : ''}`
  );
}
```

### 4. ì—ëŸ¬ ë¶„ë¥˜ ë° ì•Œë¦¼

```typescript
// ì—ëŸ¬ ì‹¬ê°ë„ ë¶„ë¥˜
private categorizeError(error: any): string {
  if (error.status >= 500) return 'CRITICAL';
  if (error.status >= 400) return 'WARNING';
  return 'INFO';
}

private logError(error: any, requestId: string, apiContext: any, duration: number) {
  const severity = this.categorizeError(error);

  this.logger.error(
    `ğŸŒ [${requestId}] [${severity}] ${apiContext.apiSummary} - ìš”ì²­ ì‹¤íŒ¨\n` +
    `   Error: ${error.message}\n` +
    `   Duration: ${duration}ms`,
    error.stack
  );

  // ì‹¬ê°í•œ ì—ëŸ¬ì¼ ê²½ìš° ì•Œë¦¼ ë°œì†¡
  if (severity === 'CRITICAL') {
    this.sendAlert(error, requestId, apiContext);
  }
}
```

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: AsyncLocalStorage ì»¨í…ìŠ¤íŠ¸ ì†ì‹¤

**ì¦ìƒ**: ì™¸ë¶€ API í˜¸ì¶œì—ì„œ ë¶€ëª¨ ìš”ì²­ ì •ë³´ê°€ ì—†ìŒ

**í•´ê²°ì±…**:

```typescript
// Promise.all ì‚¬ìš© ì‹œ ì»¨í…ìŠ¤íŠ¸ ìœ ì§€
const results = await Promise.all([
  this.httpService.get("/api1").toPromise(),
  this.httpService.get("/api2").toPromise(),
]); // âœ… ì»¨í…ìŠ¤íŠ¸ ìœ ì§€ë¨

// ë³„ë„ ìŠ¤ë ˆë“œì—ì„œ ì‹¤í–‰ ì‹œ
setTimeout(() => {
  // âŒ ì»¨í…ìŠ¤íŠ¸ ì†ì‹¤
  this.httpService.get("/api").toPromise();
}, 1000);
```

### ë¬¸ì œ 2: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜

**ì¦ìƒ**: ì¥ì‹œê°„ ì‹¤í–‰ ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì¦ê°€

**í•´ê²°ì±…**:

```typescript
// ì»¨í…ìŠ¤íŠ¸ ì •ë¦¬
private cleanupContext() {
  // AsyncLocalStorageëŠ” ìë™ìœ¼ë¡œ ì •ë¦¬ë˜ì§€ë§Œ,
  // ì¶”ê°€ ì •ë¦¬ê°€ í•„ìš”í•œ ê²½ìš°
  if (this.customContextData) {
    this.customContextData.clear();
  }
}
```

### ë¬¸ì œ 3: ìˆœí™˜ ì°¸ì¡°ë¡œ ì¸í•œ JSON.stringify ì˜¤ë¥˜

**í•´ê²°ì±…**:

```typescript
private safeStringify(obj: any): string {
  try {
    return JSON.stringify(obj, (key, value) => {
      // ìˆœí™˜ ì°¸ì¡° ì œê±°
      if (typeof value === 'object' && value !== null) {
        if (this.seen.has(value)) {
          return '[Circular Reference]';
        }
        this.seen.add(value);
      }
      return value;
    }, 2);
  } catch (error) {
    return '[Stringify Error]';
  }
}
```

---

## ğŸ“ˆ ì„±ëŠ¥ ê³ ë ¤ì‚¬í•­

### 1. ë¡œê¹… ì˜¤ë²„í—¤ë“œ ìµœì†Œí™”

```typescript
// í° ì‘ë‹µ ë°ì´í„° ì²˜ë¦¬
private truncateData(data: any, maxLength = 1000): any {
  const stringified = JSON.stringify(data);
  if (stringified.length > maxLength) {
    return `${stringified.substring(0, maxLength)}... [TRUNCATED]`;
  }
  return data;
}
```

### 2. ë¹„ë™ê¸° ë¡œê¹…

```typescript
// ë¡œê¹…ì„ ë³„ë„ íì—ì„œ ì²˜ë¦¬
private async logAsync(message: string, level: string = 'log') {
  setImmediate(() => {
    this.logger[level](message);
  });
}
```

---

## ğŸ‰ ê²°ë¡ : ë¡œê·¸ ë¶„ì„ì˜ ì•…ëª½ì—ì„œ í•´ë°©!

### ğŸš€ ì‹¤ì œ ì„±ê³¼

ì´ ì‹œìŠ¤í…œì„ ë„ì…í•œ í›„ ìš°ë¦¬ íŒ€ì˜ ë³€í™”:

- **ğŸ• ë””ë²„ê¹… ì‹œê°„ 80% ë‹¨ì¶•**: "ì´ê²Œ ë­” APIì§€?" ê°™ì€ ê³ ë¯¼ ì‚¬ë¼ì§
- **ğŸ” ë¬¸ì œ ì›ì¸ ì¦‰ì‹œ íŒŒì•…**: Request IDë¡œ ì „ì²´ í”Œë¡œìš° í•œ ë²ˆì— ì¶”ì 
- **ğŸ‘¥ íŒ€ ìƒì‚°ì„± í–¥ìƒ**: ì‹ ì… ê°œë°œìë„ ë¡œê·¸ë§Œ ë³´ê³  ë¬¸ì œ íŒŒì•… ê°€ëŠ¥
- **ğŸ› ï¸ ìš´ì˜ ì•ˆì •ì„± ì¦ëŒ€**: í”„ë¡œë•ì…˜ ì´ìŠˆ ëŒ€ì‘ ì‹œê°„ ëŒ€í­ ë‹¨ì¶•

### ğŸ’ í•µì‹¬ ê°€ì¹˜

1. **ğŸ”„ ì™„ë²½í•œ ìš”ì²­ ì¶”ì **: ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ë¶€í„° ë‚˜ê°€ëŠ” API í˜¸ì¶œê¹Œì§€ ì™„ì „ ì—°ê²°
2. **ğŸ·ï¸ Swagger ê¸°ë°˜ ê°€ë…ì„±**: "ìƒí’ˆ ë“±ë¡ í˜„í™© ì¡°íšŒ" ê°™ì€ ì§ê´€ì  ì´ë¦„ìœ¼ë¡œ ë¡œê·¸ í‘œì‹œ
3. **âš¡ ì™„ì „ ìë™í™”**: ê¸°ì¡´ ì½”ë“œ ìˆ˜ì • ì—†ì´ ì¸í„°ì…‰í„°ë§Œ ì¶”ê°€í•˜ë©´ ë
4. **ğŸ”’ ë³´ì•ˆ ê³ ë ¤**: ë¯¼ê°í•œ ë°ì´í„° ìë™ ë§ˆìŠ¤í‚¹
5. **ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**: ì‘ë‹µ ì‹œê°„ ë° ì—ëŸ¬ íŒ¨í„´ ë¶„ì„
6. **ğŸ¯ í”„ë¡œë•ì…˜ ì¤€ë¹„**: ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥
